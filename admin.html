<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin | Carmen Silfa</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23C49A6C'/><text x='50' y='50' text-anchor='middle' dy='0.35em' font-family='Playfair Display, serif' font-size='60' font-weight='bold' fill='white'>C</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .font-display { font-family: 'Playfair Display', serif; }
    
    .loader-overlay {
      position: fixed; inset: 0; background: rgba(15, 43, 77, 0.85);
      backdrop-filter: blur(8px); display: none; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .loader-spinner {
      width: 50px; height: 50px; border: 5px solid rgba(196, 154, 108, 0.2);
      border-bottom-color: #C49A6C; border-radius: 50%;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #propiedadForm label {
      color: #000000 !important;
      font-weight: 700;
    }

    #propiedadForm input, 
    #propiedadForm textarea, 
    #propiedadForm select {
      color: #000000 !important;
      border: 1.5px solid #000000 !important;
      background-color: #ffffff !important;
    }

    #propiedadForm input::placeholder, 
    #propiedadForm textarea::placeholder {
      color: #4b5563 !important;
    }
  </style>
</head>
<body class="bg-gray-50 text-secondary">

  <div id="loadingOverlay" class="loader-overlay">
    <div class="flex flex-col items-center gap-4">
      <div class="loader-spinner"></div>
      <span class="text-white font-display italic tracking-widest text-lg">Procesando Inmueble...</span>
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-6 py-12">
    
    <div class="flex justify-between items-center mb-12">
      <div>
        <h1 class="font-display text-4xl font-bold text-secondary italic">Nuevo Inmueble</h1>
        <p class="text-gray-500 mt-2">Complete los detalles para publicar en el catálogo.</p>
      </div>
      <button onclick="irPagina('index.html')" class="p-3 rounded-full hover:bg-gray-200 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

<form id="propiedadForm" class="bg-white rounded-[2.5rem] p-8 md:p-12 shadow-2xl space-y-6">
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="md:col-span-2">
      <label class="block text-sm uppercase tracking-widest mb-2">Título de la Propiedad *</label>
      <input type="text" name="titulo" required 
             class="w-full p-4 rounded-2xl text-black border-black focus:ring-2 focus:ring-primary"
             placeholder="Ej: Villa Moderna con Piscina">
    </div>

    <div>
      <label class="block text-sm uppercase tracking-widest mb-2">Ubicación *</label>
      <input type="text" name="ubicacion" required 
             class="w-full p-4 rounded-2xl text-black border-black focus:ring-2 focus:ring-primary"
             placeholder="Ej: Las Terrenas, Samaná">
    </div>

    <div>
      <label class="block text-sm uppercase tracking-widest mb-2">Precio (USD) *</label>
      <input type="number" name="precio" required 
             class="w-full p-4 rounded-2xl text-black border-black focus:ring-2 focus:ring-primary"
             placeholder="0.00">
    </div>
  </div>

  <div class="grid grid-cols-3 md:grid-cols-3 gap-4">
    <div>
      <label class="block text-xs font-bold uppercase mb-2">Habitaciones</label>
      <input type="number" name="habitaciones" value="1" class="w-full p-4 rounded-xl text-black border-black">
    </div>
    <div>
      <label class="block text-xs font-bold uppercase mb-2">Baños</label>
      <input type="number" name="banos" value="1" class="w-full p-4 rounded-xl text-black border-black">
    </div>
    <div>
      <label class="block text-xs font-bold uppercase mb-2">M² Const.</label>
      <input type="number" name="metros" value="0" class="w-full p-4 rounded-xl text-black border-black">
    </div>
  </div>

  <div>
    <label class="block text-sm uppercase tracking-widest mb-2">Descripción del Inmueble *</label>
    <textarea name="descripcion" required 
              class="w-full p-4 rounded-2xl text-black border-black min-h-[150px] focus:ring-2 focus:ring-primary"
              placeholder="Describe las características principales..."></textarea>
  </div>

  <div>
    <label class="block text-sm uppercase tracking-widest mb-2">Estado del Inmueble</label>
    <select name="estado" class="w-full p-4 rounded-2xl text-black border-black font-bold focus:ring-2 focus:ring-primary">
      <option value="EN_VENTA">Disponible</option>
      <option value="VENDIDA">Vendida</option>
    </select>
  </div>

<div class="space-y-4">
  <label class="block text-sm uppercase tracking-widest mb-2 text-black font-bold">Fotos del Inmueble (Toque para subir)</label>
  
  <div class="grid grid-cols-1 gap-4">
    <input type="file" id="file1" accept="image/*" class="hidden" onchange="actualizarUIFoto(1)">
    <label for="file1" id="label1" 
           class="w-full h-64 flex flex-col items-center justify-center bg-white border-2 border-black border-dashed rounded-[2rem] cursor-pointer overflow-hidden transition-all">
      <span class="material-symbols-outlined text-black text-4xl mb-2">add_a_photo</span>
      <span class="text-black font-bold text-sm">Foto Principal (Obligatoria)</span>
    </label>
    
    <div class="grid grid-cols-3 gap-4">
      <input type="file" id="file2" accept="image/*" class="hidden" onchange="actualizarUIFoto(2)">
      <label for="file2" id="label2" 
             class="h-32 flex items-center justify-center bg-white border-2 border-black border-dashed rounded-2xl cursor-pointer overflow-hidden">
        <span class="material-symbols-outlined text-black">image</span>
      </label>

      <input type="file" id="file3" accept="image/*" class="hidden" onchange="actualizarUIFoto(3)">
      <label for="file3" id="label3" 
             class="h-32 flex items-center justify-center bg-white border-2 border-black border-dashed rounded-2xl cursor-pointer overflow-hidden">
        <span class="material-symbols-outlined text-black">image</span>
      </label>

      <input type="file" id="file4" accept="image/*" class="hidden" onchange="actualizarUIFoto(4)">
      <label for="file4" id="label4" 
             class="h-32 flex items-center justify-center bg-white border-2 border-black border-dashed rounded-2xl cursor-pointer overflow-hidden">
        <span class="material-symbols-outlined text-black">image</span>
      </label>
    </div>
  </div>
</div>

  <button type="submit" id="btnPublicar" 
          class="w-full bg-[#C49A6C] text-white py-6 rounded-[2rem] font-bold text-xl shadow-2xl hover:bg-[#b38a5d] active:scale-[0.98] transition-all flex items-center justify-center gap-3 mt-8">
    <span id="textoBtn">Publicar Inmueble</span>
  </button>

</form>
  </div>

  <div id="successAdminModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-secondary/80 backdrop-blur-md"></div>
    <div id="successAdminContent" class="relative bg-white w-full max-w-sm rounded-[2.5rem] p-10 text-center shadow-2xl transform transition-all scale-95 opacity-0">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <span class="material-symbols-outlined text-green-600 text-5xl">check_circle</span>
      </div>
      <h3 class="font-display text-2xl font-bold mb-2 italic">¡Publicado con éxito!</h3>
      <p class="text-gray-500 text-sm mb-8">El inmueble ya está en el catálogo.</p>
      <div class="flex flex-col gap-3">
        <button onclick="location.reload()" class="w-full bg-primary text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
          <span class="material-symbols-outlined">add_circle</span> Seguir Subiendo
        </button>
        <button onclick="irPagina('index.html')" class="w-full py-4 text-gray-400 font-bold hover:text-primary transition-colors">
          Volver al Inicio
        </button>
      </div>
    </div>
  </div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbwZFKwlfCtEuqL9VIX-iAhtrXvCiYlCY34r8TotSQvpbmcJpCrh1hE29sTCB1dGD7c/exec';

  function irPagina(p) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'flex';
    window.location.href = p;
  }

  function actualizarUIFoto(n) {
    const input = document.getElementById('file' + n);
    const label = document.getElementById('label' + n);
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        label.innerHTML = `
          <img src="${e.target.result}" 
               class="w-full h-full object-cover rounded-2xl border-2 border-black shadow-sm">
        `;
        label.style.padding = "0";
        label.style.borderStyle = "solid";
        label.style.borderColor = "#000000";
      };
      
      reader.readAsDataURL(input.files[0]);
    }
  }

  function abrirModalExitoAdmin() {
    document.getElementById('loadingOverlay').style.display = 'none';
    const modal = document.getElementById('successAdminModal');
    const content = document.getElementById('successAdminContent');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    }, 10);
  }

  const comprimirImagen = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (event) => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const MAX_SIZE = 1000;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
          } else {
            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          resolve(canvas.toDataURL('image/jpeg', 0.5));
        };
      };
    });
  };

  document.getElementById('propiedadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('btnPublicar');
    const textoBtn = document.getElementById('textoBtn');
    const overlay = document.getElementById('loadingOverlay');

    btn.disabled = true;
    btn.style.opacity = "0.7";
    textoBtn.innerText = "Optimizando imágenes...";
    if (overlay) overlay.style.display = 'flex';

    try {
      const payload = {
        titulo: this.titulo.value,
        descripcion: this.descripcion.value,
        ubicacion: this.ubicacion.value,
        precio: parseFloat(this.precio.value) || 0,
        habitaciones: parseInt(this.habitaciones.value) || 0,
        banos: parseInt(this.banos.value) || 0,
        metros: parseInt(this.metros.value) || 0,
        estado: this.estado.value,
        tipo: "Casa",
        destacada: false
      };

      const promesasSubida = [];
      
      for (let i = 1; i <= 4; i++) {
        const input = document.getElementById('file' + i);
        if (input && input.files.length > 0) {
          const proceso = (async (index) => {
            const b64 = await comprimirImagen(input.files[0]);
            const response = await fetch(API_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'subir_imagen',
                base64Data: b64,
                nombreArchivo: `Prop_${Date.now()}_${index}`
              })
            });
            const data = await response.json();
            return { index, url: data.data.url };
          })(i);
          promesasSubida.push(proceso);
        }
      }

      textoBtn.innerText = "Subiendo imágenes...";
      const resultados = await Promise.all(promesasSubida);
      
      resultados.forEach(res => {
        payload['imagen' + res.index] = res.url;
      });

      textoBtn.innerText = "Guardando propiedad...";
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'crear_propiedad',
          payload: payload
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        if (overlay) overlay.style.display = 'none';
        abrirModalExitoAdmin();
      } else {
        throw new Error(data.error || 'Error desconocido');
      }

    } catch (err) {
      if (overlay) overlay.style.display = 'none';
      btn.disabled = false;
      btn.style.opacity = "1";
      textoBtn.innerText = "Reintentar";
      alert("Error: " + err.message);
    }
  });
</script>
</body>
</html>
